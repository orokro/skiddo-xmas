<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Music Box Module Test</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <style>
        body { font-family: sans-serif; background: #222; color: #eee; padding: 20px; }
        .controls { margin-bottom: 20px; }
        button { padding: 10px 20px; cursor: pointer; background: #444; color: #fff; border: 1px solid #666; }
        .visualizer { display: flex; gap: 5px; height: 200px; align-items: flex-end; margin-top: 20px; border-bottom: 2px solid #555; }
        .key-strip { flex: 1; background: #333; height: 100%; display: flex; align-items: flex-end; justify-content: center; }
        .prong { width: 80%; background: #d4af37; border-radius: 4px 4px 0 0; }
        /* NO CSS TRANSITION HERE, JS handles it all */
    </style>
</head>
<body>
    <h1>Music Box (Sampler Version)</h1>
    <div class="controls">
        <button id="btn-play">Play</button>
        <button id="btn-pause">Pause</button>
        <button id="btn-stop">Stop</button>
    </div>
    <div id="time-display">Time: 0.00</div>
    <div class="visualizer" id="visualizer-container"></div>

    <script type="module">
        import { MusicBoxPlayer } from './music-box-player.js';

        // 1. Setup Data (Jingle Bells snippet)
        const BEAT = 0.5;
        let t = 0;
        const notes = [];
        const add = (k, dur) => notes.push({startTime:t, endTime:t+(dur*BEAT), key:k});
        const adv = (b) => t += (b*BEAT);

        // Keys 0-17
        const keys = ["G3","A3","B3","C4","D4","E4","F4","G4","A4","B4","C5","D5","E5","F5","G5","A5","B5","C6"];
        const [E4, G4, C4, D4] = [5, 7, 3, 4]; // indices

        // Composition
        add(E4,1); adv(1); add(E4,1); adv(1); add(E4,2); adv(2); // Jingle Bells
        add(E4,1); adv(1); add(E4,1); adv(1); add(E4,2); adv(2); // Jingle Bells
        add(E4,1); adv(1); add(G4,1); adv(1); add(C4,1); adv(1); add(D4,1); adv(1); add(E4,4); adv(4); // All the way

        const song = { songName: "Jingle Bells", speed: 1.0, keys: keys, notes: notes };

        // 2. Setup Visuals
        const container = document.getElementById('visualizer-container');
        const visualProngs = keys.map(k => {
            const s = document.createElement('div'); s.className='key-strip';
            const p = document.createElement('div'); p.className='prong'; p.style.height='0%';
            s.appendChild(p); container.appendChild(s);
            return p;
        });

        // 3. Setup Player
        const player = new MusicBoxPlayer({ rampTime: 0.1 }); // 0.1s snap
        player.load(song);

        player.onPlayData(data => {
            document.getElementById('time-display').innerText = `Time: ${data.time.toFixed(3)}`;
            data.morphTargets.forEach((mt, i) => {
                if(visualProngs[i]) visualProngs[i].style.height = (mt.value * 50) + '%';
            });
        });

        // 4. Bind Buttons
        document.getElementById('btn-play').onclick = () => player.play();
        document.getElementById('btn-pause').onclick = () => player.pause();
        document.getElementById('btn-stop').onclick = () => player.stop();
    </script>
</body>
</html>