<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Music Box Engine Test</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <style>
        body { font-family: sans-serif; background: #222; color: #eee; padding: 20px; }
        .controls { margin-bottom: 20px; }
        button { padding: 10px 20px; cursor: pointer; font-size: 16px; background: #444; color: #fff; border: 1px solid #666; border-radius: 4px; }
        button:hover { background: #555; }
        
        .visualizer {
            display: flex;
            gap: 5px;
            height: 200px;
            align-items: flex-end;
            margin-top: 20px;
            border-bottom: 2px solid #555;
            padding-bottom: 5px;
        }
        
        .key-strip {
            flex: 1;
            background: #333;
            position: relative;
            height: 100%;
            border-radius: 4px 4px 0 0;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            align-items: center;
        }

        .prong {
            width: 80%;
            background: linear-gradient(to top, #d4af37, #f9e295);
            transition: height 0.05s linear; /* Smooth visual update */
            border-radius: 4px 4px 0 0;
        }

        .label {
            font-size: 10px;
            color: #aaa;
            margin-top: 5px;
            text-align: center;
        }
        
        #time-display { font-family: monospace; font-size: 1.2em; margin-top: 10px; color: #d4af37; }
    </style>
</head>
<body>

    <h1>Virtual Music Box Engine</h1>
    
    <div class="controls">
        <button id="btn-play">Play</button>
        <button id="btn-pause">Pause</button>
        <button id="btn-stop">Stop</button>
    </div>

    <div id="time-display">Time: 0.00</div>

    <div class="visualizer" id="visualizer-container">
        </div>

    <script src="music-box-player.js"></script>

    <script>
        // --- 1. Define Song Data (Jingle Bells) ---
        
        // Helper to make writing notes easier
        // We assume 1 beat = 0.5 seconds (120 BPM)
        const BEAT = 0.5;
        let tCursor = 0; // Time cursor

        const notesList = [];

        function addNote(keyIndex, durationBeats) {
            notesList.push({
                startTime: tCursor,
                endTime: tCursor + (durationBeats * BEAT),
                key: keyIndex
            });
            // We don't auto-advance cursor because music boxes are polyphonic, 
            // we advance manually in the song composition below
        }

        function advance(beats) {
            tCursor += (beats * BEAT);
        }

        // Key Mapping (C Major Scale mostly)
        // Index 0 to 17
        const songKeys = [
            "G3", "A3", "B3",  // Bass/Lower
            "C4", "D4", "E4", "F4", "G4", "A4", "B4", // Mid
            "C5", "D5", "E5", "F5", "G5", "A5", "B5", "C6" // High
        ];
        
        // Indices for readability
        const G3=0, C4=3, D4=4, E4=5, F4=6, G4=7, A4=8, C5=10, D5=11, E5=12;

        // Composition: Jingle Bells (Chorus)
        
        // "Jingle Bells" (E-E-E)
        addNote(E4, 1); advance(1);
        addNote(E4, 1); advance(1);
        addNote(E4, 2); advance(2);

        // "Jingle Bells" (E-E-E)
        addNote(E4, 1); advance(1);
        addNote(E4, 1); advance(1);
        addNote(E4, 2); advance(2);

        // "Jingle All The Way" (E-G-C-D-E)
        addNote(E4, 1); advance(1);
        addNote(G4, 1); advance(1);
        addNote(C4, 1); advance(1);
        addNote(D4, 1); advance(1);
        addNote(E4, 4); advance(4);

        // "Oh what fun it is to ride" (F-F-F-F-F-E-E)
        addNote(F4, 1); advance(1);
        addNote(F4, 1); advance(1);
        addNote(F4, 1); advance(1);
        addNote(F4, 1); advance(1);
        addNote(F4, 1); advance(1);
        addNote(E4, 1); advance(1);
        addNote(E4, 1); advance(1);
        
        // "In a one horse open sleigh" (E-E-E-D-D-E-D-G)
        addNote(E4, 0.5); advance(0.5);
        addNote(E4, 0.5); advance(0.5);
        addNote(E4, 1); advance(1);
        addNote(D4, 1); advance(1);
        addNote(D4, 1); advance(1);
        addNote(E4, 1); advance(1);
        addNote(D4, 2); advance(2);
        addNote(G4, 2); advance(2);


        const demoSong = {
            songName: "Jingle Bells",
            speed: 1.0, // Normal speed
            keys: songKeys,
            notes: notesList
        };

        // --- 2. Initialize UI ---

        const container = document.getElementById('visualizer-container');
        const visualProngs = [];

        // Generate HTML bars for the 18 keys
        songKeys.forEach((k, i) => {
            const strip = document.createElement('div');
            strip.className = 'key-strip';
            
            const prong = document.createElement('div');
            prong.className = 'prong';
            prong.style.height = '0%';
            
            const label = document.createElement('div');
            label.className = 'label';
            label.innerText = k; // Note Name
            // Or use "K" + (i+1) for Key Number

            strip.appendChild(prong);
            container.appendChild(strip);
            strip.appendChild(label);

            visualProngs.push(prong);
        });

        const timeDisplay = document.getElementById('time-display');

        // --- 3. Initialize Engine ---

        const player = new MusicBoxPlayer({ rampPercent: 0.005 }); // 5% ramp for visibility
        player.load(demoSong);

        // --- 4. The Data Loop ---

        player.onPlayData((data) => {

            // Update Time Display
            timeDisplay.innerText = `Norm Time: ${data.time.toFixed(3)}`;

            // Update Visuals based on MorphTargets
            // In ThreeJS, you would do: mesh.morphTargetInfluences[index] = val
            data.morphTargets.forEach((mt, index) => {
				
                const domProng = visualProngs[index];
                if(domProng) {
                    // Visualizing the ramp (0.0 to 1.0) as height %
                    // Multiplied by 50 to keep it within the box
                    domProng.style.height = (mt.value * 50) + '%';
                    
                    // Change color when it "snaps" (playing) vs ramping
                    if(mt.value === 0) {
                        domProng.style.opacity = '0.5';
                    } else {
                        domProng.style.opacity = '1.0';
                    }
                }
            });
        });

        // --- 5. Controls ---

        document.getElementById('btn-play').addEventListener('click', () => {
            player.play();
        });

        document.getElementById('btn-pause').addEventListener('click', () => {
            player.pause();
        });

        document.getElementById('btn-stop').addEventListener('click', () => {
            player.stop();
            // Reset visuals manually
            visualProngs.forEach(p => p.style.height = '0%');
            timeDisplay.innerText = "Time: 0.00";
        });

    </script>
</body>
</html>
